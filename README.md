# helm-webapp-cve-consumer

This Helm chart deploys the CVE Consumer application, which consumes CVE (Common Vulnerabilities and Exposures) data from a Kafka topic and stores it in a PostgreSQL database.

## Prerequisites

Before deploying this Helm chart, ensure you have the following:

- Kubernetes cluster (version 1.25+)
- Helm (version 3.0+)
- Access to the Kafka cluster deployed on the Kubernetes cluster
- Namespaces created for the deployment

## Installation

To install the chart with the release name `csye7125`:

```bash
helm install csye7125 csye7125.tar.gz -f values.yaml -n ns3
```

## Configuration

The following table lists the configurable parameters of the `csye7125-consumer` chart and their default values.

| Parameter                    | Description                                 | Default                                      |
|------------------------------|---------------------------------------------|----------------------------------------------|
| `replicaCount`               | Number of consumer replicas                 | 1                                            |
| `namespace`                  | Namespace to deploy the consumer            | ns1                                          |
| `app.image`                  | Consumer application image                  | chlokesh1306/cve-consumer           |
| `app.tag`                    | Consumer application image tag              | latest                                       |
| `app.pullPolicy`             | Image pull policy                           | Always                                       |
| `app.env`                    | Environment variables for the consumer app  | See `values.yaml` for defaults               |
| `postgres.image`             | PostgreSQL image                            | postgres                                     |
| `postgres.tag`               | PostgreSQL image tag                        | 15.3                                         |
| `postgres.pullPolicy`        | PostgreSQL image pull policy                | IfNotPresent                                 |
| `postgres.env`               | Environment variables for PostgreSQL        | See `values.yaml` for defaults               |
| `storage.size`               | Size of persistent volume claim             | 1Gi                                          |
| `imagePullSecrets.name`      | Name of the image pull secret               | dockerhub                                    |
| `imagePullSecrets.dockerconfigjson` | Base64 encoded Docker config JSON    | See `values.yaml` for defaults               |

Specify each parameter using the `--set key=value[,key=value]` argument to `helm install`. For example:

```bash
helm install csye7125 csye7125.tar.gz -f values.yaml -n ns3 --set replicaCount=3
```

Alternatively, a YAML file that specifies the values for the parameters can be provided while installing the chart. For example:

```bash
helm install csye7125 csye7125.tar.gz -f values.yaml -n ns3
```

## Architecture

This Helm chart deploys the following components:

- CVE Consumer application (Deployment)
- PostgreSQL database (StatefulSet)
- Services for the consumer and PostgreSQL
- Persistent Volume Claim for PostgreSQL data
- Horizontal Pod Autoscaler for the consumer application

The consumer application reads CVE data from a Kafka topic and stores it in the PostgreSQL database. The application is configured to handle potential duplicates and updates to existing CVE records.

## Persistence

The chart mounts a Persistent Volume for PostgreSQL. The volume is created using dynamic volume provisioning.

## CI/CD Pipeline
This repository follows a CI/CD process that integrates GitHub and Jenkins using webhooks to trigger automated workflows. The CI/CD process ensures that code quality, chart validation, and versioning are handled automatically before code can be merged and released.

### CI/CD Workflow Overview
#### GitHub -> Jenkins Integration
- GitHub Webhook: A webhook is configured on this repository to trigger Jenkins jobs on specific GitHub events (e.g., pull requests).
- Jenkins Pipelines: There are two Jenkins pipelines (Jenkinsfile1 and Jenkinsfile2) that handle validation, linting, and publishing Helm charts.

#### CI/CD Pipeline Flow
##### Code Validation and Linting (Jenkinsfile1)

- Trigger: Pull requests to the main branch
- This pipeline performs several checks to ensure the quality and validity of the Helm chart and that the commit messages adhere to the Conventional Commits standard before allowing a merge.

##### Helm Chart Publishing (Jenkinsfile2)
- Trigger: Merging a pull request into the main branch
- Once the code passes all validations, and a pull request is merged, this pipeline automatically versions and publishes the Helm chart to GitHub releases.

## Upgrading

To upgrade the chart:

```bash
helm upgrade csye7125 csye7125.tar.gz -f values.yaml -n ns3
```

## Uninstalling

To uninstall/delete the my-release deployment:

```bash
helm delete csye7125
```
This command removes all the Kubernetes components associated with the chart and deletes the release.

## Troubleshooting

If you encounter issues:

Check the status of the pods:

```bash
kubectl get pods -n ns3
```

View the logs of the consumer application:

```bash
kubectl logs -f <consumer-pod-name> -n ns3
```

Check the PostgreSQL logs:

```bash
kubectl logs -f <postgres-pod-name> -n ns3
```